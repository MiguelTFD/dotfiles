#!/bin/bash

STATE_DIR="$HOME/.local/state/theme-manager"
STATE_FILE="$STATE_DIR/theme-mode.txt"
LOCK_FILE="/tmp/theme-manager.lock"
PALETTE_DIR="$HOME/.config/palette"

mkdir -p "$STATE_DIR"

if [ ! -f "$STATE_FILE" ]; then
  echo "Dark" > "$STATE_FILE"
fi

get_current_theme() {
  cat "$STATE_FILE"  
}

update_symlinks() {
  local theme_mode="$1"
  local theme_dir="$PALETTE_DIR/${theme_mode,,}"
  
  declare -A symlink_map=(
    ["alacritty.palette.yml"]="$HOME/.config/alacritty/colors.yml"
    ["gtk3.palette.ini"]="$HOME/.config/gtk-3.0/settings.ini"
    ["i3.palette.conf"]="$HOME/.config/i3/colors.conf"
    ["polybar.palette.ini"]="$HOME/.config/polybar/colors.ini"
    ["rofi.palette.rasi"]="$HOME/.config/rofi/themes/colors.rasi"
    ["bat.palette"]="$HOME/.config/bat/config"
    ["dunst.palette.conf"]="$HOME/.config/dunst/dunstrc.d/colors.conf"
  )
  
  for source_file in "${!symlink_map[@]}"; do
    local source_path="$theme_dir/$source_file"
    local target_path="${symlink_map[$source_file]}"
    
    mkdir -p "$(dirname "$target_path")"
    
    [ -L "$target_path" ] && rm "$target_path"
    
    if [ -f "$source_path" ]; then
      ln -sf "$source_path" "$target_path"
      echo "✓ Linked: $target_path -> $source_path"
    else
      echo "⚠ Warning: $source_path not found"
    fi
  done
}

load_theme() {
  local theme_mode
  theme_mode=$(get_current_theme)
  
  echo "Loading $theme_mode theme..."
  update_symlinks "$theme_mode"
  systemctl --user restart dunst.service &> /dev/null 
  i3-msg restart &> /dev/null
}

toggle_theme() {
  local current_theme new_theme
  
  exec 200>"$LOCK_FILE"
  flock -n 200 || {
    echo "Toggle in progress, please wait..."
    return 1
  }
  
  current_theme=$(get_current_theme)
  
  if [ "$current_theme" = "Dark" ]; then
    new_theme="Light"
  else
    new_theme="Dark"
  fi
  
  echo "$new_theme" > "$STATE_FILE"
  load_theme
  
  if command -v dunstify &> /dev/null; then
    dunstify -u low -t 2000 "Theme: $new_theme" "Updated Colors"
  fi
  
  exec 200>&-
}

case "${1:-}" in
  --toggle)
    toggle_theme
    ;;
  --load)
    load_theme
    ;;
  *)
    echo "Usage: $0 {--toggle|--load}"
    echo "  --toggle - Switch between Dark and Light themes"
    echo "  --load   - Reload current theme"
    exit 1
    ;;
esac
