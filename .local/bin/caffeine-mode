#!/bin/bash

STATE_FILE="/tmp/polybar_caffeine_state"
PID_FILE="/tmp/polybar_caffeine_pid"

if [ ! -f "$STATE_FILE" ]; then
  echo "0" > "$STATE_FILE"
fi

get_state() {
  state=$(cat "$STATE_FILE")
  if [ "$state" -eq "1" ]; then
    echo "%{B#665c54}%{F#bdae93}  "
  else
    echo "%{B#665c54}%{F#bdae93} "
  fi
}

change_state() {
  state=$(cat "$STATE_FILE")
  
  if [ "$state" -eq "0" ]; then
    echo "1" > "$STATE_FILE"
    
    xset -dpms
    xset s off
    
    light-locker-command --inhibit > /dev/null 2>&1 &
    
    echo $! > "$PID_FILE"
    
    dunstify -u low -t 2000 'Caffeine: ON' 'Suspensión e inhibición activas'
  else
    echo "0" > "$STATE_FILE"
    
    xset +dpms
    xset s on
    
    if [ -f "$PID_FILE" ]; then
        kill "$(cat "$PID_FILE")"
        rm "$PID_FILE"
    fi
    
    dunstify -u low -t 2000 'Caffeine: OFF' 'Sistema normalizado'
  fi
}

case "$1" in
  --toggle)
    change_state
    ;;
  *)
    get_state
    ;;
esac
